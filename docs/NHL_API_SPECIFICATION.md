# NHL Player Points Prediction API Specification

**Version:** 1.0.0
**Last Updated:** 2025-11-26
**Status:** Production Ready

---

## Table of Contents

1. [Overview](#overview)
2. [Database Schema](#database-schema)
3. [API Endpoints](#api-endpoints)
4. [Data Models](#data-models)
5. [Query Patterns](#query-patterns)
6. [Business Logic](#business-logic)
7. [Error Handling](#error-handling)
8. [Appendix](#appendix)

---

## Overview

### Purpose

This API serves NHL player points predictions generated by a machine learning pipeline. The system predicts which players are most likely to score at least one point (goal or assist) in their upcoming games.

### Data Flow

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  Daily Pipeline │────▶│  PostgreSQL DB   │────▶│   REST API      │
│  (9AM/12PM/3PM) │     │  (Source of Truth)│     │  (Read-Only)    │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

### Key Concepts

- **Prediction**: A scored player for a specific game date
- **Settlement**: Comparing predictions to actual game results
- **Hit Rate**: Percentage of predictions where player scored 1+ point
- **Confidence Tier**: Classification of prediction reliability (very_high, high, medium, low)

---

## Database Schema

### Primary Tables

#### 1. `nhl_daily_predictions` (Main Table)

This is the **primary data source** for all prediction-related endpoints.

```sql
CREATE TABLE nhl_daily_predictions (
    -- Primary Key
    prediction_id       SERIAL PRIMARY KEY,

    -- Composite Unique Constraint
    player_id           INTEGER NOT NULL,
    game_id             INTEGER NOT NULL,
    analysis_date       DATE NOT NULL,
    UNIQUE (player_id, game_id, analysis_date),

    -- Player Identity
    player_name         VARCHAR(255),
    team                VARCHAR(10),      -- 3-letter abbreviation (e.g., 'COL', 'TOR')
    position            VARCHAR(5),       -- 'C', 'L', 'R', 'D'
    opponent            VARCHAR(10),      -- Opposing team abbreviation
    is_home             BOOLEAN,

    -- Scoring (Higher = Better)
    final_score         NUMERIC(8,4),     -- Range: ~50-100, composite score
    rank                INTEGER,          -- 1 = top pick of the day
    confidence          VARCHAR(20),      -- 'very_high', 'high', 'medium', 'low'

    -- Component Scores (0-1 scale, weighted into final_score)
    recent_form_score       NUMERIC(8,4),
    line_opportunity_score  NUMERIC(8,4),
    goalie_weakness_score   NUMERIC(8,4),
    matchup_score           NUMERIC(8,4),
    situational_score       NUMERIC(8,4),

    -- Component Details (JSONB for debugging/transparency)
    component_details   JSONB,

    -- Line/Power Play Position
    line_number         INTEGER,          -- 1, 2, 3, or 4 (1 = top line)
    pp_unit             INTEGER,          -- 0 = no PP, 1 = PP1, 2 = PP2
    avg_toi_minutes     NUMERIC(6,2),     -- Average time on ice

    -- Recent Performance
    recent_ppg          NUMERIC(6,3),     -- Points per game (last 10 games)
    recent_games        INTEGER,          -- Games in recent window
    recent_points       INTEGER,
    recent_goals        INTEGER,
    recent_assists      INTEGER,
    point_streak        INTEGER,          -- Consecutive games with a point

    -- Opposing Goalie
    opposing_goalie_id      INTEGER,
    opposing_goalie_name    VARCHAR(255),
    opposing_goalie_sv_pct  NUMERIC(6,4),  -- Save percentage (e.g., 0.9120)
    opposing_goalie_gaa     NUMERIC(6,3),  -- Goals against average (e.g., 2.85)
    goalie_confirmed        BOOLEAN,       -- True if starting goalie confirmed

    -- Matchup Method
    matchup_method      VARCHAR(30),      -- 'nhl_api_conditional', 'elite_goalie_weighted', etc.

    -- Situational Factors
    is_b2b              BOOLEAN DEFAULT FALSE,  -- Back-to-back game
    is_b2b2b            BOOLEAN DEFAULT FALSE,  -- Third game in 4 nights
    days_rest           INTEGER,
    opposing_goalie_b2b BOOLEAN DEFAULT FALSE,

    -- Season Stats (Context)
    season_games        INTEGER,
    season_goals        INTEGER,
    season_assists      INTEGER,
    season_points       INTEGER,
    season_pp_goals     INTEGER,

    -- Settlement (Filled After Game)
    actual_points       INTEGER,          -- NULL until settled
    actual_goals        INTEGER,
    actual_assists      INTEGER,
    point_outcome       INTEGER,          -- 1=HIT, 0=MISS, 2=PPD, 3=DNP, NULL=unsettled

    -- Timestamps
    created_at          TIMESTAMP DEFAULT timezone('utc', now()),
    updated_at          TIMESTAMP DEFAULT timezone('utc', now())
);

-- Essential Indexes
CREATE INDEX idx_nhl_predictions_date ON nhl_daily_predictions(analysis_date);
CREATE INDEX idx_nhl_predictions_rank ON nhl_daily_predictions(analysis_date, rank);
CREATE INDEX idx_nhl_predictions_settlement ON nhl_daily_predictions(analysis_date, point_outcome);
CREATE INDEX idx_nhl_predictions_player ON nhl_daily_predictions(player_id, analysis_date);
CREATE INDEX idx_nhl_predictions_streak ON nhl_daily_predictions(analysis_date, point_streak DESC);
```

#### 2. `nhl_daily_insights` (LLM Cache Table)

Caches expensive LLM-generated narratives and full insight reports.

```sql
CREATE TABLE nhl_daily_insights (
    id                  SERIAL PRIMARY KEY,
    analysis_date       DATE NOT NULL UNIQUE,

    -- LLM Content
    llm_narrative       TEXT,             -- Full AI-generated analysis
    llm_model           VARCHAR(100),     -- e.g., 'google/gemini-2.0-flash-001'

    -- Full Report (Computed Insights)
    full_report         JSONB,            -- Complete InsightsReport object

    -- Metadata
    total_predictions   INTEGER,
    games_count         INTEGER,
    generated_at        TIMESTAMP,
    created_at          TIMESTAMP DEFAULT timezone('utc', now()),
    updated_at          TIMESTAMP DEFAULT timezone('utc', now())
);
```

#### 3. `nhl_games` (Game Schedule)

```sql
CREATE TABLE nhl_games (
    game_id             INTEGER PRIMARY KEY,  -- NHL API game ID (e.g., 2025020360)
    home_team           VARCHAR(10),
    away_team           VARCHAR(10),
    game_date           DATE,
    game_time           TIMESTAMP,
    season              VARCHAR(10),          -- e.g., '20252026'
    status              VARCHAR(20),          -- 'Scheduled', 'Final', 'InProgress', 'Postponed'
    home_score          INTEGER,
    away_score          INTEGER,
    created_at          TIMESTAMP DEFAULT timezone('utc', now()),
    updated_at          TIMESTAMP DEFAULT timezone('utc', now())
);
```

#### 4. `nhl_players` (Player Master Data)

```sql
CREATE TABLE nhl_players (
    player_id           INTEGER PRIMARY KEY,  -- NHL API player ID
    full_name           VARCHAR(255),
    team                VARCHAR(10),
    position            VARCHAR(5),
    jersey_number       INTEGER,
    created_at          TIMESTAMP DEFAULT timezone('utc', now()),
    updated_at          TIMESTAMP DEFAULT timezone('utc', now())
);
```

#### 5. `nhl_line_combinations` (Line Tracking)

```sql
CREATE TABLE nhl_line_combinations (
    id                  SERIAL PRIMARY KEY,
    team                VARCHAR(10) NOT NULL,
    captured_date       DATE NOT NULL,
    source              VARCHAR(100),         -- 'DailyFaceoff - Jason Gregor'
    source_updated_at   TIMESTAMP,
    forward_lines       JSONB,                -- {1: {lw, c, rw}, 2: {...}}
    defense_pairs       JSONB,                -- {1: {ld, rd}, 2: {...}}
    power_play          JSONB,                -- {1: {players: [...]}}
    penalty_kill        JSONB,
    goalies             JSONB,                -- [{name, jersey_number, is_starter}]
    players_by_line     JSONB,                -- {player_name: {line, pp_unit, position}}
    created_at          TIMESTAMP DEFAULT timezone('utc', now()),
    UNIQUE (team, captured_date)
);
```

---

## API Endpoints

### Base URL

```
https://api.example.com/v1/nhl
```

### Authentication

All endpoints require Bearer token authentication:
```
Authorization: Bearer <API_KEY>
```

---

### Endpoint 1: Get Daily Predictions

**GET** `/predictions/{date}`

Returns ranked predictions for a specific date.

#### Path Parameters

| Parameter | Type | Format | Required | Description |
|-----------|------|--------|----------|-------------|
| date | string | YYYY-MM-DD | Yes | Analysis date |

#### Query Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| limit | integer | 25 | Max results (1-100) |
| offset | integer | 0 | Pagination offset |
| confidence | string | null | Filter by: `very_high`, `high`, `medium`, `low` |
| team | string | null | Filter by team abbreviation |
| position | string | null | Filter by position: `C`, `L`, `R`, `D` |
| min_score | number | null | Minimum final_score threshold |

#### SQL Query Pattern

```sql
SELECT
    prediction_id,
    player_id,
    player_name,
    team,
    position,
    opponent,
    is_home,
    game_id,
    final_score,
    rank,
    confidence,
    line_number,
    pp_unit,
    point_streak,
    recent_ppg,
    opposing_goalie_name,
    opposing_goalie_sv_pct,
    opposing_goalie_gaa,
    goalie_confirmed,
    is_b2b,
    -- Include settlement data if available
    actual_points,
    point_outcome
FROM nhl_daily_predictions
WHERE analysis_date = :date
  AND (:confidence IS NULL OR confidence = :confidence)
  AND (:team IS NULL OR team = :team)
  AND (:position IS NULL OR position = :position)
  AND (:min_score IS NULL OR final_score >= :min_score)
ORDER BY rank ASC
LIMIT :limit OFFSET :offset;
```

#### Response Schema

```json
{
  "date": "2025-11-26",
  "total_count": 732,
  "returned_count": 25,
  "predictions": [
    {
      "prediction_id": 12345,
      "rank": 1,
      "player_id": 8478402,
      "player_name": "Connor Bedard",
      "team": "CHI",
      "position": "C",
      "opponent": "MIN",
      "is_home": true,
      "game_id": 2025020380,
      "final_score": 71.97,
      "confidence": "high",
      "line_number": 1,
      "pp_unit": 1,
      "point_streak": 4,
      "recent_ppg": 1.6,
      "opposing_goalie": {
        "name": "Filip Gustavsson",
        "sv_pct": 0.905,
        "gaa": 2.89,
        "confirmed": true
      },
      "situational": {
        "is_b2b": false,
        "days_rest": 2
      },
      "settlement": {
        "actual_points": null,
        "outcome": null
      }
    }
  ]
}
```

---

### Endpoint 2: Get Hot Streaks

**GET** `/hot-streaks/{date}`

Returns players on significant point streaks.

#### SQL Query Pattern

```sql
SELECT
    player_id,
    player_name,
    team,
    position,
    opponent,
    rank,
    final_score,
    confidence,
    point_streak,
    recent_ppg,
    recent_points,
    recent_games
FROM nhl_daily_predictions
WHERE analysis_date = :date
  AND (point_streak >= 3 OR recent_ppg >= 1.2)
  AND rank <= 50  -- Focus on top players
ORDER BY
    point_streak DESC,
    recent_ppg DESC
LIMIT 15;
```

#### Response Schema

```json
{
  "date": "2025-11-26",
  "hot_streaks": [
    {
      "player_id": 8478402,
      "player_name": "Connor Bedard",
      "team": "CHI",
      "position": "C",
      "opponent": "MIN",
      "rank": 1,
      "final_score": 71.97,
      "confidence": "high",
      "streak_info": {
        "point_streak": 5,
        "recent_ppg": 1.6,
        "recent_points": 8,
        "recent_games": 5
      },
      "insight_type": "extended_hot_streak",
      "headline": "Connor Bedard is on fire",
      "details": "5-game point streak | 1.60 PPG over last 10"
    }
  ]
}
```

---

### Endpoint 3: Get Parlay Recommendations

**GET** `/parlays/{date}`

Returns algorithmically generated parlay recommendations.

#### Response Schema

```json
{
  "date": "2025-11-26",
  "parlays": {
    "conservative": {
      "type": "conservative",
      "leg_count": 2,
      "combined_confidence": "high",
      "rationale": "Top 2 picks from different games - minimizes correlation risk",
      "estimated_hit_probability": 0.35,
      "legs": [
        {
          "player_id": 8478402,
          "player_name": "Connor Bedard",
          "team": "CHI",
          "opponent": "MIN",
          "game_id": 2025020380,
          "final_score": 71.97,
          "confidence": "high",
          "line_number": 1,
          "pp_unit": 1,
          "point_streak": 4
        },
        {
          "player_id": 8477492,
          "player_name": "Nathan MacKinnon",
          "team": "COL",
          "opponent": "SJS",
          "game_id": 2025020381,
          "final_score": 71.90,
          "confidence": "high",
          "line_number": 1,
          "pp_unit": 1,
          "point_streak": 3
        }
      ]
    },
    "balanced": {
      "type": "balanced",
      "leg_count": 3,
      "combined_confidence": "medium",
      "rationale": "Position-diverse selection for balanced exposure",
      "estimated_hit_probability": 0.20,
      "legs": [/* ... */]
    },
    "aggressive": {
      "type": "aggressive",
      "leg_count": 4,
      "combined_confidence": "medium",
      "rationale": "All PP1 players - high-volume opportunity seekers",
      "estimated_hit_probability": 0.12,
      "legs": [/* ... */]
    },
    "moonshot": {
      "type": "moonshot",
      "leg_count": 5,
      "combined_confidence": "low",
      "rationale": "Top 5 overall picks - high risk, high reward",
      "estimated_hit_probability": 0.07,
      "legs": [/* ... */]
    }
  }
}
```

#### Parlay Selection Algorithm

```sql
-- Conservative: Top 2 from DIFFERENT games
WITH ranked AS (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY game_id ORDER BY rank) as game_rank
    FROM nhl_daily_predictions
    WHERE analysis_date = :date AND rank <= 15
)
SELECT * FROM ranked WHERE game_rank = 1 ORDER BY rank LIMIT 2;

-- Balanced: Top 3 with POSITION diversity
WITH ranked AS (
    SELECT *,
        CASE position WHEN 'C' THEN 'center' WHEN 'D' THEN 'defense' ELSE 'wing' END as pos_group,
        ROW_NUMBER() OVER (
            PARTITION BY CASE position WHEN 'C' THEN 'center' WHEN 'D' THEN 'defense' ELSE 'wing' END
            ORDER BY rank
        ) as pos_rank
    FROM nhl_daily_predictions
    WHERE analysis_date = :date AND rank <= 15
)
SELECT * FROM ranked WHERE pos_rank = 1 ORDER BY rank LIMIT 3;

-- Aggressive: Top 4 PP1 players
SELECT * FROM nhl_daily_predictions
WHERE analysis_date = :date AND pp_unit = 1
ORDER BY rank LIMIT 4;

-- Moonshot: Top 5 on hot streaks (or top 5 overall)
SELECT * FROM nhl_daily_predictions
WHERE analysis_date = :date AND point_streak >= 3
ORDER BY rank LIMIT 5;
```

---

### Endpoint 4: Get Full Insights Report

**GET** `/insights/{date}`

Returns the complete insights report including LLM narrative.

#### SQL Query Pattern

```sql
-- First check for cached report
SELECT
    analysis_date,
    llm_narrative,
    llm_model,
    full_report,
    total_predictions,
    games_count,
    generated_at
FROM nhl_daily_insights
WHERE analysis_date = :date;

-- If no cache, compute on-the-fly (more expensive)
```

#### Response Schema

```json
{
  "date": "2025-11-26",
  "generated_at": "2025-11-26T09:15:32Z",
  "total_predictions": 732,
  "games_count": 14,
  "llm_narrative": "## NHL Points Analysis for November 26, 2025\n\n**Top Pick: Connor Bedard** continues his dominant stretch...",
  "llm_model": "google/gemini-2.0-flash-001",
  "top_5_picks": [
    {
      "rank": 1,
      "player_name": "Connor Bedard",
      "team": "CHI",
      "opponent": "MIN",
      "final_score": 71.97,
      "confidence": "high"
    }
  ],
  "hot_streaks": [/* PlayerInsight objects */],
  "elite_opportunities": [/* PlayerInsight objects */],
  "goalie_vulnerabilities": [/* GoalieInsight objects */],
  "parlays": {/* ParlayRecommendation objects */},
  "recent_performance": {
    "period": "Last 5 days",
    "start_date": "2025-11-21",
    "end_date": "2025-11-25",
    "total_predictions": 240,
    "hits": 144,
    "misses": 96,
    "hit_rate": 60.0
  }
}
```

---

### Endpoint 5: Get Settlement Summary

**GET** `/performance/summary`

Returns overall system performance metrics.

#### Query Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| start_date | string | 30 days ago | Start of date range |
| end_date | string | yesterday | End of date range |

#### SQL Query Pattern

```sql
-- Overall hit rate
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN point_outcome = 1 THEN 1 ELSE 0 END) as hits,
    SUM(CASE WHEN point_outcome = 0 THEN 1 ELSE 0 END) as misses,
    SUM(CASE WHEN point_outcome IN (2, 3) THEN 1 ELSE 0 END) as excluded,
    ROUND(
        SUM(CASE WHEN point_outcome = 1 THEN 1 ELSE 0 END)::numeric /
        NULLIF(SUM(CASE WHEN point_outcome IN (0, 1) THEN 1 ELSE 0 END), 0) * 100,
        1
    ) as hit_rate
FROM nhl_daily_predictions
WHERE point_outcome IS NOT NULL
  AND analysis_date BETWEEN :start_date AND :end_date;

-- By confidence tier
SELECT
    confidence,
    COUNT(*) as total,
    SUM(CASE WHEN point_outcome = 1 THEN 1 ELSE 0 END) as hits,
    ROUND(
        SUM(CASE WHEN point_outcome = 1 THEN 1 ELSE 0 END)::numeric /
        NULLIF(SUM(CASE WHEN point_outcome IN (0, 1) THEN 1 ELSE 0 END), 0) * 100,
        1
    ) as hit_rate
FROM nhl_daily_predictions
WHERE point_outcome IS NOT NULL
  AND analysis_date BETWEEN :start_date AND :end_date
GROUP BY confidence
ORDER BY
    CASE confidence
        WHEN 'very_high' THEN 1
        WHEN 'high' THEN 2
        WHEN 'medium' THEN 3
        WHEN 'low' THEN 4
    END;

-- By rank bucket
SELECT
    CASE
        WHEN rank <= 5 THEN 'Top 5'
        WHEN rank <= 10 THEN 'Top 10'
        WHEN rank <= 25 THEN 'Top 25'
        ELSE 'Other'
    END as rank_bucket,
    COUNT(*) as total,
    SUM(CASE WHEN point_outcome = 1 THEN 1 ELSE 0 END) as hits,
    ROUND(
        SUM(CASE WHEN point_outcome = 1 THEN 1 ELSE 0 END)::numeric /
        NULLIF(SUM(CASE WHEN point_outcome IN (0, 1) THEN 1 ELSE 0 END), 0) * 100,
        1
    ) as hit_rate
FROM nhl_daily_predictions
WHERE point_outcome IS NOT NULL
  AND analysis_date BETWEEN :start_date AND :end_date
GROUP BY 1
ORDER BY
    CASE
        WHEN rank <= 5 THEN 1
        WHEN rank <= 10 THEN 2
        WHEN rank <= 25 THEN 3
        ELSE 4
    END;
```

#### Response Schema

```json
{
  "period": {
    "start_date": "2025-10-26",
    "end_date": "2025-11-25"
  },
  "overall": {
    "total_predictions": 14580,
    "settled": 13200,
    "excluded": 1380,
    "hits": 7920,
    "misses": 5280,
    "hit_rate": 60.0
  },
  "by_confidence": [
    {"tier": "very_high", "total": 2400, "hits": 1680, "hit_rate": 70.0},
    {"tier": "high", "total": 4800, "hits": 3120, "hit_rate": 65.0},
    {"tier": "medium", "total": 4200, "hits": 2310, "hit_rate": 55.0},
    {"tier": "low", "total": 1800, "hits": 810, "hit_rate": 45.0}
  ],
  "by_rank": [
    {"bucket": "Top 5", "total": 150, "hits": 105, "hit_rate": 70.0},
    {"bucket": "Top 10", "total": 150, "hits": 97, "hit_rate": 65.0},
    {"bucket": "Top 25", "total": 450, "hits": 270, "hit_rate": 60.0},
    {"bucket": "Other", "total": 12450, "hits": 7448, "hit_rate": 59.8}
  ]
}
```

---

### Endpoint 6: Get Player History

**GET** `/players/{player_id}/history`

Returns prediction history for a specific player.

#### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| player_id | integer | Yes | NHL API player ID |

#### Query Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| limit | integer | 30 | Max results |
| include_unsettled | boolean | false | Include unsettled predictions |

#### SQL Query Pattern

```sql
SELECT
    analysis_date,
    opponent,
    is_home,
    final_score,
    rank,
    confidence,
    line_number,
    pp_unit,
    point_streak,
    actual_points,
    actual_goals,
    actual_assists,
    point_outcome
FROM nhl_daily_predictions
WHERE player_id = :player_id
  AND (:include_unsettled = true OR point_outcome IS NOT NULL)
ORDER BY analysis_date DESC
LIMIT :limit;
```

---

### Endpoint 7: Get Games Schedule

**GET** `/games/{date}`

Returns scheduled games for a date.

#### SQL Query Pattern

```sql
SELECT
    g.game_id,
    g.home_team,
    g.away_team,
    g.game_date,
    g.game_time,
    g.status,
    g.home_score,
    g.away_score,
    -- Count predictions per game
    (SELECT COUNT(*) FROM nhl_daily_predictions p
     WHERE p.game_id = g.game_id AND p.analysis_date = g.game_date) as prediction_count
FROM nhl_games g
WHERE g.game_date = :date
ORDER BY g.game_time;
```

---

## Data Models

### Enum Values

#### `confidence`
| Value | Description | Expected Hit Rate |
|-------|-------------|-------------------|
| very_high | Top-tier prediction | 65-75% |
| high | Strong prediction | 58-65% |
| medium | Moderate confidence | 50-58% |
| low | Lower confidence | 40-50% |

#### `point_outcome`
| Value | Description |
|-------|-------------|
| 1 | HIT - Player scored 1+ point |
| 0 | MISS - Player scored 0 points |
| 2 | PPD - Game postponed |
| 3 | DNP - Player did not play |
| NULL | Not yet settled |

#### `position`
| Value | Description |
|-------|-------------|
| C | Center |
| L | Left Wing |
| R | Right Wing |
| D | Defenseman |

#### `matchup_method`
| Value | Description |
|-------|-------------|
| nhl_api_conditional | Standard API-based matching |
| elite_goalie_weighted | Weighted for elite goalies |
| situational_boost | Includes B2B/rest factors |

### Team Abbreviations

```json
{
  "ANA": "Anaheim Ducks",
  "ARI": "Arizona Coyotes",
  "BOS": "Boston Bruins",
  "BUF": "Buffalo Sabres",
  "CGY": "Calgary Flames",
  "CAR": "Carolina Hurricanes",
  "CHI": "Chicago Blackhawks",
  "COL": "Colorado Avalanche",
  "CBJ": "Columbus Blue Jackets",
  "DAL": "Dallas Stars",
  "DET": "Detroit Red Wings",
  "EDM": "Edmonton Oilers",
  "FLA": "Florida Panthers",
  "LAK": "Los Angeles Kings",
  "MIN": "Minnesota Wild",
  "MTL": "Montreal Canadiens",
  "NSH": "Nashville Predators",
  "NJD": "New Jersey Devils",
  "NYI": "New York Islanders",
  "NYR": "New York Rangers",
  "OTT": "Ottawa Senators",
  "PHI": "Philadelphia Flyers",
  "PIT": "Pittsburgh Penguins",
  "SJS": "San Jose Sharks",
  "SEA": "Seattle Kraken",
  "STL": "St. Louis Blues",
  "TBL": "Tampa Bay Lightning",
  "TOR": "Toronto Maple Leafs",
  "UTA": "Utah Hockey Club",
  "VAN": "Vancouver Canucks",
  "VGK": "Vegas Golden Knights",
  "WSH": "Washington Capitals",
  "WPG": "Winnipeg Jets"
}
```

---

## Business Logic

### Parlay Construction Rules

1. **Conservative (2-leg)**
   - Select top 2 by rank
   - Must be from DIFFERENT games
   - Purpose: Minimize correlation risk

2. **Balanced (3-leg)**
   - Select top 3 by rank
   - Must have position diversity (center, wing, defense)
   - Purpose: Balanced exposure across positions

3. **Aggressive (4-leg)**
   - Select top 4 PP1 players only
   - Purpose: Target high-opportunity players

4. **Moonshot (5-leg)**
   - Select players with point_streak >= 3
   - Fallback: top 5 overall if insufficient hot streaks
   - Purpose: High risk, high reward

### Hot Streak Detection

A player qualifies as "hot" if:
```sql
point_streak >= 3 OR recent_ppg >= 1.2
```

Insight types:
- `extended_hot_streak`: point_streak >= 5
- `hot_streak`: point_streak >= 3
- `high_ppg`: recent_ppg >= 1.2 (but streak < 3)

### Goalie Vulnerability Detection

A goalie is "vulnerable" if:
```sql
opposing_goalie_gaa >= 3.2 OR opposing_goalie_sv_pct <= 0.890
```

Insight types:
- `high_gaa`: GAA >= 3.5
- `low_sv_pct`: SV% <= 0.880
- `cold_streak`: GAA >= 3.2 OR SV% <= 0.890

---

## Error Handling

### HTTP Status Codes

| Code | Meaning |
|------|---------|
| 200 | Success |
| 400 | Bad Request (invalid parameters) |
| 401 | Unauthorized (missing/invalid API key) |
| 404 | Not Found (no data for date) |
| 429 | Rate Limited |
| 500 | Internal Server Error |

### Error Response Format

```json
{
  "error": {
    "code": "INVALID_DATE",
    "message": "Date must be in YYYY-MM-DD format",
    "details": {
      "provided": "11-26-2025",
      "expected_format": "YYYY-MM-DD"
    }
  }
}
```

### Common Errors

| Code | Description |
|------|-------------|
| INVALID_DATE | Date format is incorrect |
| FUTURE_DATE | Cannot query future dates beyond tomorrow |
| NO_GAMES | No games scheduled for this date |
| NO_PREDICTIONS | Predictions not yet generated for this date |
| SETTLEMENT_PENDING | Games not yet completed |

---

## Appendix

### A. Sample Curl Commands

```bash
# Get today's predictions
curl -H "Authorization: Bearer $API_KEY" \
  "https://api.example.com/v1/nhl/predictions/2025-11-26?limit=10"

# Get hot streaks
curl -H "Authorization: Bearer $API_KEY" \
  "https://api.example.com/v1/nhl/hot-streaks/2025-11-26"

# Get parlays
curl -H "Authorization: Bearer $API_KEY" \
  "https://api.example.com/v1/nhl/parlays/2025-11-26"

# Get full insights
curl -H "Authorization: Bearer $API_KEY" \
  "https://api.example.com/v1/nhl/insights/2025-11-26"

# Get performance summary
curl -H "Authorization: Bearer $API_KEY" \
  "https://api.example.com/v1/nhl/performance/summary?start_date=2025-10-08"
```

### B. Data Refresh Schedule

| Time (Pacific) | Operation | Description |
|----------------|-----------|-------------|
| 9:00 AM | Full Pipeline | Settlement + Fresh predictions + LLM insights |
| 12:00 PM | Refresh | Force-refresh predictions (no LLM) |
| 3:00 PM | Final Refresh | Force-refresh predictions (no LLM) |

### C. Game ID Format

NHL API game IDs follow this format:
```
YYYYTTNNNN

YYYY = Season start year (2025 for 2025-26 season)
TT   = Game type (02 = regular season, 03 = playoffs)
NNNN = Game number (0001-1312 for regular season)

Example: 2025020360 = 2025-26 season, regular season, game #360
```

### D. Confidence Tier Assignment Logic

```python
def assign_confidence(final_score: float, line: int, pp_unit: int, goalie_confirmed: bool) -> str:
    if final_score >= 70 and line == 1 and pp_unit == 1 and goalie_confirmed:
        return "very_high"
    elif final_score >= 67 and line <= 2 and pp_unit in [1, 2]:
        return "high"
    elif final_score >= 63:
        return "medium"
    else:
        return "low"
```

---

## Revision History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-11-26 | Initial specification |
